// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import "./DeltaSetup.f.sol";

contract ForkTestPolygon is DeltaSetup {
    function setUp() public virtual override {
        vm.createSelectFork({blockNumber: 59993125, urlOrAlias: "https://polygon-rpc.com"});
        address admin = 0x999999833d965c275A2C102a4Ebf222ca938546f;
        address proxy = 0x6A6faa54B9238f0F079C8e6CBa08a7b9776C7fE4;
        address oldModule = 0x26A27420d7257a159DEcbb5b6EF05199DD20eAE5;
        upgradeExistingDelta(proxy, admin, oldModule);
    }

    // skipt this one for now
    function test_permit_polygon() external /** address user, uint8 lenderId */ {
        address user = 0x91ae002a960e63Ccb0E5bDE83A8C13E51e1cB91A;
        vm.prank(user);
        // vm.expectRevert(); // should revert with overflow
        IFlashAggregator(brokerProxyAddress).deltaCompose(getSwapWithPermit());
    }

    // skipt this one for now
    function test_generic_polygon() external /** address user, uint8 lenderId */ {
        address user = 0xb5C99bf3F9B8EDf2A532614049e9EE4302670a4a; // 0x91ae002a960e63Ccb0E5bDE83A8C13E51e1cB91A;
        vm.prank(user);
        // vm.expectRevert(); // should revert with overflow
        (bool success, bytes memory ret) = address(brokerProxyAddress).call(getGenericData());
        if (!success) {
            // Next 5 lines from https://ethereum.stackexchange.com/a/83577
            if (ret.length < 68) revert();
            assembly {
                ret := add(ret, 0x04)
            }
            revert(abi.decode(ret, (string)));
        }
    }

    function getSwapWithPermit() internal pure returns (bytes memory data) {
        // this data is correct for bloclk 59909525
        data = hex"32f329e36c7bf6e5e86ce2150875a84ce77f47737500e000000000000000000000000091ae002a960e63ccb0e5bde83a8c13e51e1cb91a0000000000000000000000006a6faa54b9238f0f079c8e6cba08a7b9776c7fe40000000000000000000000000000000000000000000000000221405dd9d7791f0000000000000000000000000000000000000000000000000000000066a643f5000000000000000000000000000000000000000000000000000000000000001c6106cedd1eee05901450585ba677ba4f29aaa5953bce23eb679224ba4a363feb38503fdaaf6105b10ebfca6342bb8b9ca775295803cd9d79f37571d74b11ef4034ffd6df932a45c0f255f85145f286ea0b292b21c90b000000000000021bda57da3830f4054204d6df932a45c0f255f85145f286ea0b292b21c90b216b4b4ba9f3e719726886d34a177484278bfcaedef171fe48cf0115b1d80b88dc8eab59176fee57000000000000021bcc8639e810cd04842298207a0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000d6df932a45c0f255f85145f286ea0b292b21c90b0000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c3359000000000000000000000000000000000000000000000000021bda57da3830f40000000000000000000000000000000000000000000000000000000000e8855b000000000000000000000000000000000000000000000000021bcc8639e810cd00000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000003a0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000066a68ca346a9c2eccf9c4fa6b4f19394cfc36017000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000e592427a0aece92de3edee1f18e0157c058615640000000000000000000000000000000000000000000000000000000000000144f28c0498000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000def171fe48cf0115b1d80b88dc8eab59176fee570000000000000000000000000000000000000000000000000000000066af72c30000000000000000000000000000000000000000000000000000000000e8855b000000000000000000000000000000000000000000000000021bda57da3830f400000000000000000000000000000000000000000000000000000000000000423c499c542cef5e3811e1192ce70d8cc03d5c33590001f453e0bca35ec356bd5dddfebbd1fc0fd03fabad39002710d6df932a45c0f255f85145f286ea0b292b21c90b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000144000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000123c499c542cef5e3811e1192ce70d8cc03d5c335991ae002a960e63ccb0e5bde83a8c13e51e1cb91a00020000000000000000000000e8943c13d6df932a45c0f255f85145f286ea0b292b21c90bba12222222228d8ba445958a75a0704d566bf2c800000000000000021bda57da3830f4223c499c542cef5e3811e1192ce70d8cc03d5c335991ae002a960e63ccb0e5bde83a8c13e51e1cb91a00000000000000000000000000000010d6df932a45c0f255f85145f286ea0b292b21c90b91ae002a960e63ccb0e5bde83a8c13e51e1cb91a000000000000000000000000000000";
    }

    function getGenericData() internal pure returns (bytes memory data) {
        // this data is incorrect for block 59993125
        data = hex"17d730910000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000018c230000000000004563918244f40000006a6faa54b9238f0f079c8e6cba08a7b9776c7fe4800000000000000000010f688ff8d04a0000000000001bc16d674ec80000002f0d500b1d8e8ef31e21c99d1db9a6444d3adf1270000300b8177ceb23fd6bc0add59e62ac25578270cff1b9f619ff09006a6faa54b9238f0f079c8e6cba08a7b9776c7fe4800000000000000000010fc1cc94df7f0000000000001bc16d674ec8000000480d500b1d8e8ef31e21c99d1db9a6444d3adf12700003009fa78f3cf7ad23cd3cadbd9735aff958023239c6a06300020000647ceb23fd6bc0add59e62ac25578270cff1b9f619ff09006a6faa54b9238f0f079c8e6cba08a7b9776c7fe48000000000000000000087c8959114370000000000000de0b6b3a7640000002f0d500b1d8e8ef31e21c99d1db9a6444d3adf127000000000647ceb23fd6bc0add59e62ac25578270cff1b9f619ff09107ceb23fd6bc0add59e62ac25578270cff1b9f619b5c99bf3f9b8edf2a532614049e9ee4302670a4a1900000000000000000000000000000000000000000000000000000000000000000000";
    }
}
